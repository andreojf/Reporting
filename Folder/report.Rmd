---
title: "Reporting mensuel sur le risque de crédit - `r params$arrete`"
date: "`r Sys.time()`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    toc_float: false
    number_sections: true
    theme: cerulean
params:
  arrete: '2020-12-31'
  prev1Arrete: '2020-11-30'
  prev2Arrete: '2020-10-31'
  moisArrete: Decembre
  anneeArrete: 2020
  pays: Burkina
  profondeur: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
p {
  font-family: "Times New Roman", Times, serif;
  font-size: 20px
}

h1, h2, h3{
  font-weight: bold;
  font-family: "Times New Roman", Times, serif;
}

.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
```


```{r echo=FALSE}
library(shiny)
```

```{r include=FALSE, message=FALSE, warning=FALSE}
source("CodesCredit/importData.R")
source("CodesCredit/preparation.R")
source("CodesCredit/portef_bancaire.R")
source("CodesCredit/byNotation.R")
source("CodesCredit/bySegment.R")
source("CodesCredit/byBCEAO.R")
source("CodesCredit/CDLparAge.R")
source("CodesCredit/EngagementsHorsBilan.R")
source("CodesCredit/50PlusGrosEngagements.R")
source("CodesCredit/synthese.R")
```


# Situation du portefeuille

## Vision par pays

Cette section décrit la situation du portefeuille de chacun des (08) entités. 

### Burkina
```{r echo=FALSE, message=FALSE}
#source("portef_bancaire.R")
```

### Benin
```{r echo=FALSE, message=FALSE}
country = "Benin"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
library(plyr)
country = "Benin"
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reportée dans le tableau suivant:

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\

### Côte d'Ivoire
```{r echo=FALSE, message=FALSE}
country = "CI"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reporté dans le tableau suivant:

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\


### Guinée
```{r echo=FALSE, message=FALSE}
country = "Benin"
```

### Mali
```{r echo=FALSE, message=FALSE}
country = "ML"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reporté dans le tableau suivant:
  
  ```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\

### Niger
```{r echo=FALSE, message=FALSE}
country = "NG"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reporté dans le tableau suivant:

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\

### Sénégal
```{r echo=FALSE, message=FALSE}
country = "SN"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reporté dans le tableau suivant:
  
  ```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\

### Togo 
```{r echo=FALSE, message=FALSE}
country = "TG"
```

L'évolution du portefeuille de CBI **`r country`** sur les (03) trois derniers mois.

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvol(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\
La synthèse suivant les Sains, Restructurés et Douteux et litigieux est reporté dans le tableau suivant:

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfEvolGlobal(pays = country) %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille de CBI ", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  ) 
```
\
\


## Vision agrégée

La vision agrégée reprend les mêmes informations que précédemment. Les chiffres sont obtenus en sommant les montants de toutes entités. 
\

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfAgrege %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille du groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\

```{r echo=FALSE, message=FALSE}
final.df %>%
  pfAgregeGlobal %>%
  pfFormatTable(country = country, params = params) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille au niveau groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\
\
**Observations:**
`r final.df %>% pfAgregeGlobal %>% storyPtf `

# Répartition suivant la qualité 

Cette section synthétise les montants des engagements directs (Trésorerie) et indirects (Signature) selon les classes de risques.

## Vision par Pays

```{r echo=FALSE, message=FALSE}
detach("package:plyr", unload = TRUE)
final.df %>%
  notationParPays2(arrete = params$arrete) %>%
  tab_header(
    title = md(paste("**Répartition du portefeuille de chaque pays suivant les classes de risques**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\
\

## Vision consolidée

La vision consolidée aggrège les mêmes informations que précédemment à l'échelle du groupe (toutres les entités).
```{r echo=FALSE, message=FALSE}
# detach("package:plyr", unload = TRUE)
final.df %>%
  notationConsolidee(arrete = params$arrete) %>%
  tab_header(
    title = md(paste("**Situation globale du portefeuille au niveau groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```

\
\

## Matrice de passage

Cette section décrit les transitions effectuées entre `r params$arrete` et `r params$prev1Arrete``. Il s'agit du taux de contreparties ayant transité d'une classe de risque A vers une classe de risque B entre deux arrêtés.

\

### Benin

```{r echo=FALSE, message=FALSE}
country = "Benin"
d = as.Date(params$arrete)

transTab <- final.df %>%
  transNotation(country, d, params$profondeur)
transTab$transitionPropGt %>%
  tab_header(
    title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
    subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
  )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `

### Côte d'Ivoire
```{r echo=FALSE, message=FALSE}
# country = "CI"
# d = as.Date(params$arrete)
# profondeur = 1
# transTab <- final.df %>%
#   transNotation(country, d, profondeur)
# transTab$transitionPropGt %>%
#   tab_header(
#     title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
#     subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
#   )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `

### Guinée

### Mali
```{r echo=FALSE, message=FALSE}
# country = "ML"
# d = as.Date(params$arrete)
# profondeur = 1
# transTab <- final.df %>%
#   transNotation(country, d, profondeur)
# transTab$transitionPropGt %>%
#   tab_header(
#     title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
#     subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
#   )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `

### Niger
```{r echo=FALSE, message=FALSE}
# country = "NG"
# d = as.Date(params$arrete)
# profondeur = 1
# transTab <- final.df %>%
#   transNotation(country, d, profondeur)
# transTab$transitionPropGt %>%
#   tab_header(
#     title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
#     subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
#   )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `

### Sénégal
```{r echo=FALSE, message=FALSE}
# country = "SN"
# d = as.Date(params$arrete)
# profondeur = 1
# transTab <- final.df %>%
#   transNotation(country, d, profondeur)
# transTab$transitionPropGt %>%
#   tab_header(
#     title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
#     subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
#   )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `

### TOGO
```{r echo=FALSE, message=FALSE}
# country = "TG"
# d = as.Date(params$arrete)
# profondeur = 1
# transTab <- final.df %>%
#   transNotation(country, d, profondeur)
# transTab$transitionPropGt %>%
#   tab_header(
#     title = md(paste("**Matrice de transition de ", country, "**", sep = "")),
#     subtitle = paste("entre", params$prev1Arrete ,"et",params$arrete)
#   )
```
\
**Observations:**
`r transTab$transitionProp %>% storyNotation `


# Répartition suivant le segment


Cette section donne la situation des engagements (directs et indirects), des restructurés, des CES (Créances en souffrance) ainsi que des taux de dégradation et des taux de provisions par segment. Ces segments ont été définis par le groupe.

## Vision par pays
\


```{r echo=FALSE, message=FALSE}
final.df %>%
  SegmentParPays(params$arrete) %>%
  tab_header(
    title = md(paste("**Répartition du portefeuille de chaque pays suivant la segmentation groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\

## Vision consolidée
\
```{r echo=FALSE, message=FALSE}
final.df %>%
  SegmentConsolide(params$arrete) %>%
  tab_header(
    title = md(paste("**Répartition du portefeuille consolidé suivant les classes de risques**")),
    subtitle = paste("arreté du",params$arrete)
  )
```



# Répartition suivant le secteur d'activité

Cette section reprend les montants des engagements du bilan et du hors bilan en plus des taux de provisionnement et de dégradation par secteur d'activité. Ces sections d'activités sont définis conformément au critères de la BCEAO.

## Vision par pays
\

```{r echo=FALSE, message=FALSE}
final.df %>%
  BCEAOparPays("2020-12-31") %>%
  tab_header(
    title = md(paste("**Situation du portefeuille détaillée par pays suivant les secteurs d'activité de la BCEAO**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\

## Vision consolidée
\
```{r echo=FALSE, message=FALSE}
final.df %>%
  BCEAOConsolidee("2020-12-31") %>%
  tab_header(
    title = md(paste("**Répartition du portefeuille consolidé suivant les secteurs d'activité de la BCEAO**")),
    subtitle = paste("arreté du",params$arrete)
  )
```

```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```
# CDL par age

Cette section donne les montants de Encours douteux et litigieux, les montants et taux de provisions par ancienneté de déclassement.

## Vision par pays
\

```{r echo=FALSE, message=FALSE}
arrete = as.Date(params$arrete)
final.df %>%
  declassementparPays(arrete) %>%
  tab_header(
    title = md(paste("**Déclassement par Pays**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\
## Vision consolidée
\
```{r echo=FALSE, message=FALSE}
arrete = as.Date("31/12/2020", format="%d/%m/%Y")
final.df %>%
  declassementConsolidee(arrete) %>%
  tab_header(
    title = md(paste("**Déclassement au niveau groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```

```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```
# Engagements hors bilan

Les engagements hors bilan sont repris dans le tableau ci-dessous. 
Il est important de rappeler que le tableau intègre les avals de traite qui sont des informations fournies par chaque entité:

```{r echo=FALSE, message=FALSE}
avalTraite = t(data.frame(Benin = 1000000, 
              CI = 5000000, 
              ML = 2500000,
              NG = 1500000,
              SN = 2300000,
              TG = 2000000, row.names = c("AVALSTRAITE"))) %>%
  as.data.frame %>%
  rownames_to_column("Pays")
  
  avalTraite %>%
  gt %>%
  fmt_number(
    columns = c(AVALSTRAITE),
    #scale_by = 1 / 1E6,
    #pattern = "{x} M",
    decimals = 0
  ) %>%
  summary_rows(
    columns = AVALSTRAITE,
    fns = list(TOTAL = "sum"),
    formatter = fmt_number,
    #scale_by = 1 / 1E6,
    #pattern = "{x} M",
    decimals = 0
  ) %>%
  cols_label(
    AVALSTRAITE = "Montant Aval"
  ) %>%
  tab_header(
    title = md(paste("**Avals de traite par Pays**")),
    subtitle = paste("arreté du",params$arrete)
  ) %>%
  tab_options(
    #table.width = pct(80),
    table.font.size = px(13)
  ) 

```
\

Après prise en compte des avals de traite de chaque pays:
\

```{r echo=FALSE, message=FALSE}
final.df %>%
  HorsBilanparPays(params$arrete, avalTraite) %>%
  tab_header(
    title = md(paste("**Hors bilan par pays**")),
    subtitle = paste("arreté du",params$arrete)
  )
```



```{r echo=FALSE, message=FALSE}
```

```{r echo=FALSE, message=FALSE}
```
# 50 plus gros engagements

Cette section fait le top 50 des contreparties detenant les plus gros engagements par pays.

```{r echo=FALSE, message=FALSE}
top50 <- final.df %>%
  top50ParPays(params$arrete) %>%
  tab_header(
    title = md(paste("**50 plus gros engagements**")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\
\
```{r echo=FALSE, message=FALSE}
final.df %>%
  top50Consolidee(params$arrete) %>%
  tab_header(
    title = md(paste("**50 plus gros engagements au niveau groupe**")),
    subtitle = paste("arreté du",params$arrete)
  )
```

# Synthèse des indicateurs

Cette section fait la synthèse des indicateurs. Elle donne également une vision évolutive du portefeuille sur les (03) derniers arrêtés.

## Vision par pays

### Benin
Tous les indicateurs sont synthétisés dans le tableau ci-dessous.
\
```{r echo=FALSE, message=FALSE}
country = "Benin"
synthTab$SynthMontant %>%
  pfSyntFormatTable(params, ratio=F) %>%
  tab_header(
    title = md(paste("**Synthèse des indicateurs de CBI", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```
Le précédent tableau permet l'obtention du tableau suivant. Il s'agit essentiellement des principaux ratios.
\
```{r echo=FALSE, message=FALSE}
synthTab$SynthRatio %>%
  pfSyntFormatTable(params, ratio=T) %>%
  tab_header(
    title = md(paste("**Synthèse des ratios de CBI", country, "**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```
## Vision consolidée

La synthèse des indicateurs au niveaux Groupe sont présentés dans les tableaux ci-dessous:

```{r echo=FALSE, message=FALSE}
synthTabGroup$SynthMontant %>%
  pfSyntFormatTable(params, ratio=F) %>%
  tab_header(
    title = md(paste("**Synthèse des indicateurs niveau Groupe**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```
\
\
```{r echo=FALSE, message=FALSE}
synthTabGroup$SynthRatio %>%
  pfSyntFormatTable(params, ratio=T) %>%
  tab_header(
    title = md(paste("**Synthèse des ratios niveau Groupe**", sep = "")),
    subtitle = paste("arreté du",params$arrete)
  )
```

# Indicateurs d'appétence au risque 
